<!DOCTYPE html>
<html><head>
<meta charset="utf-8"> 
<link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">
<!-- COMMENT  <meta name="viewport" content="width=device-width, initial-scale=1.0">  -->
<title>Bitcoin QR Code Generator</title>
<style>
	* {
		box-sizing: border-box;
		font-family: 'Ubuntu', sans-serif;
	}

	body {
		background-color: #808080;
	}

	input {
		border-radius: 6px;
		padding: 4px;
		border: 1px #404040 solid;
		/* background-color: #808080; */
		/* background-color: #A9A9A9; */
	}

	input[type="text"]:focus {
		outline: 0;
		box-shadow: 0 0 1px 4px rgb(77, 184, 255, .7);
	}

	.page-container {
		display: flex;
		flex-direction: row;
		flex-wrap: wrap;
		justify-content: space-around;
	}

	/*The 1st item of page-container*/
	.input-container {
		width: 60%;
		display: flex;
		flex-direction: column;
		align-items: center; 
		border-radius: 10px;
		background-color: #A9A9A9;
	}

	/*1st item of input-container*/
	.address_section {
		display: flex;
		flex-direction: column;
		width: 100%;
		padding: 10px;
	}
	
	.address_text {
		display: flex;
		justify-content: space-between;
	}

	.address_input {
		width: 100%;
		border: 1.5px #404040 solid;
		font-size: 15pt;
		padding: 5px;
		margin: 4px 0;
	}

	.address_input:focus {
		outline: 0;
		border: 1.5px solid #00b300;
		box-shadow: 0 0 1px 4px rgb(0, 255, 0, .4);
	}

	.validitation_text {
		visibility: hidden;
	}

	/*2nd item of input-container*/
	.uri_input_container {
		display: flex;
		flex-direction: row;
		justify-content: space-around;
		flex-wrap: wrap;
		width: 100%;
		padding: 10px;
		background-color: lightblue;
	}

	/*1st item uri_input_container*/	
	.container_of_textboxes {
		display: flex;
		flex-direction: column;
		max-width: 100%;
	}

	/*Each of these is an item of container_of_textboxes*/
	.uri_label_and_input_container {
		display: flex;
		flex-direction: row:
		justify-content: flex-end;
		padding: 3px;
	}

	.uri_label_and_input_container input {
		font-size: 11pt;
		min-width: 170px;
	}

	.uri_label_and_input_container label {
		width: 85px;
	}

	/*2nd item uri_input_container*/	
	.uricheckbox {	/*Centering textbox vertically*/
		display: flex;
		flex-direction: column;
		justify-content: center;
	}

	/*3rd item of input-container*/
	.custom_section {
		width: 100%;
		background-color: #ff99ff;
		padding: 10px;
	}

	.custom_input {
		width: 100%;
		font-size: 13pt;
		margin: 3px 0;
	}

	.qr_code_string {
		padding: 10px;
		background-color: #ff751a;
	}

	/*The 2nd item of page-container*/
	.qr_image_container {
		display: flex;
		flex-direction: column;
		align-items: center;  /*cross axis (i.e. the horizontal axis for our column) centered.*/
		padding: 25px;
        border-radius: 10px;
		background-color: #A9A9A9;
	}

	/*2nd item of qr_image_container*/
	.download_button {
		padding: 10px;
		margin: 10px;
	}

</style>
</head>
<body>
    <div align="center" style="border: 2px yellow solid; margin-bottom: 5px;">
        <h3>Bitcoin QR Code Generator</h3>
    </div>
	<div class="page-container">
		<div class="input-container">
			<div class="address_section"> 
				<div class="address_text"><label>Enter Bitcoin Address: </label><div class="validitation_text" id="validitation_text">test</div></div>
				<input class="address_input" type="text" id="address" autocomplete="off" placeholder="Enter Bitcoin address." spellcheck="false" onfocusout="lose_address_focus()" onfocus="gain_address_focus()" oninput="gen_qrcode('addr_change')">
				
			</div>
			<div class="uri_input_container">
				<div name="amount-label-message" class="container_of_textboxes">
					<div class="uri_label_and_input_container"><label>Amount: </label><input oninput="gen_qrcode('amt_change')" type="text" id="amount" autocomplete="off"></div>
					<div class="uri_label_and_input_container"><label>Label: </label><input oninput="gen_qrcode('label_change')" type="text" id="label" autocomplete="off"></div>
					<div class="uri_label_and_input_container"><label>Message: </label><input oninput="gen_qrcode('message_change')" type="text" id="message" autocomplete="off"></div>
				</div>
				<div class="uricheckbox">
					<p>Bitcoin URI <input type="checkbox" id="uri" oninput="gen_qrcode('uri_change')"></p>
				</div>
			</div>
			<div class="custom_section">
				<label>Enter Custom String: </label><br><input class="custom_input" oninput="gen_qrcode('custom_change')" type="text" id="custom_id" autocomplete="off">
			</div>
			<div class="qr_code_string">
				Exact QR String here.
			</div>
		</div>
		<div class="qr_image_container">
			<p id=your_address_id></p>
			<br>
			<div id="qrcode_id"></div>
			<input class="download_button" type="button" id="dwn-btn" value="Download QR Code">
		</div>
	</div>


<script src="qrcode.js"></script>
<script src="wallet-address-validator.js"></script>
<script type="text/javascript">


	var address_valid_state = "unset";
	function address_error (){
		document.getElementById("address").style.border = "2px solid red";
		document.getElementById("address").style.boxShadow = "0 0 1px 4px rgb(255, 0, 0, .4)";
		document.getElementById("validitation_text").style.visibility = "visible";
		document.getElementById("validitation_text").innerHTML = "Invalid Bitcoin address!";
		document.getElementById("validitation_text").style.color = "red";
		address_valid_state = "false";
	}
	function address_valid (){
		document.getElementById("address").style.border = "2px solid #00b300";
		document.getElementById("address").style.boxShadow = "0 0 1px 4px rgb(0, 255, 0, .4)";
		document.getElementById("validitation_text").style.visibility = "visible";
		document.getElementById("validitation_text").innerHTML = "Valid Bitcoin address.";
		document.getElementById("validitation_text").style.color = "green";
		address_valid_state = "true";
	}
	function lose_address_focus(){
		if (address_valid_state != "unset"){
			document.getElementById("address").style.boxShadow = "none";
		}
	}
	function gain_address_focus(){
		if (address_valid_state == "true"){
			address_valid();
		}
		else if (address_valid_state == "false"){
			address_error();
		}
	}
//<!-- COMMENT  filebreak  -->



//HTML element ID variables.
var uri_checkbox_obj;
var amt_obj;
var label_obj;
var message_obj;
var custom_obj;
var addr_obj;

//Set whenever user modifies an input box, let's gen_qrcode() subroutine know what input was changed.
var page_change;

//Other variables.
var addr_valid = false;  //Records whether bitcoin address is valid or not at a given time.
var addr_empty = true;  //Records whether the address field is empty or not at a given time.
var stored_addr = "";   //Records the current address field, so that it can be brought back at a later time.

var amt_valid = false;
var amt_empty = true;
var last_amt = "";
var stored_amt = "";

var uri_encoded_label = "";
var label_empty = true;
var stored_label = "";

var uri_encoded_message = "";
var message_empty = true;
var stored_message = "";

var custom_empty = true;
var custom_empty_state_changed = false;

var uri_checked = false;
    var address_valid_state = "unset";

function determine_qr_code_value(){
    var qr_value = "";
    if (custom_empty){
        if (addr_valid){
            if (uri_checked){
                //Do not generate a QR-Code if amount is not empty and not a valid number.
                //Written for hanging decimal (i.e. "3.").
                if (!amt_valid && !amt_empty){
                        qr_value = "";
                        return qr_value;
                }
                //Otherwise, generate a QR-Code value in uri format.
                //Uri format specifications: https://github.com/bitcoin/bips/blob/master/bip-0021.mediawiki
                else{
                    qr_value = "bitcoin:" + addr_obj.value;
                }
                //Create array of fields and one with their values to add to uri.
                var uri_field_name_array = [];
                var uri_field_value_array = [];
                if (amt_valid){
                    uri_field_name_array.push("amount");
                    uri_field_value_array.push(amt_obj.value);
                }
                if (!label_empty){
                    uri_field_name_array.push("label");
                    uri_field_value_array.push(uri_encoded_label);
                }
                if (!message_empty){
                    uri_field_name_array.push("message");
                    uri_field_value_array.push(uri_encoded_message);
                }
                //If fields are present, prepare uri with '?', otherwise, return current uri.
                if (uri_field_value_array.length > 0){
                    qr_value = qr_value + "?";
                }

                else{
                    return qr_value;
                }
                //Populate uri with field names and values.
                while (uri_field_name_array.length > 0){
                    qr_value = qr_value + uri_field_name_array.shift() + "=" + uri_field_value_array.shift();
                    if (uri_field_name_array.length > 0){
                        qr_value = qr_value + "&";
                    }
                }
                return qr_value;
            }
            //If uri checkbox not checked, then the QR-code is just the address.
            else{
                qr_value = addr_obj.value;
                return qr_value;
            }
        }
        //If address is invalid, no valid qr code value.
        else{
            qr_value = "";
            return qr_value;
        }
    }
    //If custom value is filled, then QR-Code value defaults to that.
    else{
        qr_value = custom_obj.value;
        return qr_value;
    }
}

function hide_qrcode(){
    document.getElementById('your_address_id').innerHTML = "";
    document.getElementById('qrcode_id').innerHTML = "";
    //Don't show a QR Code unless it is a valid one.
        document.getElementById("dwn-btn").style.visibility = "hidden";
}

function make_qrcode(input_text){
//console.log("input_text: " + input_text );
//alert("input_text: " + input_text );
    var qrcode;
    if ( input_text != "" ) {
        //Input fully formed address/uri in readable html.
        document.getElementById('your_address_id').innerHTML = input_text;
        qrcode = new QRCode("qrcode_id");
        qrcode.makeCode(input_text);
        document.getElementById("dwn-btn").style.visibility = "visible";
    }
}

//Update page based on change of page_change variable (which records the most recent change to the page by the user).
//The "page_change" variable is whichever field was modified (addr_change, amt_change, label_change, message_change, custom_change, or uri_change.)
function update_page(page_change){
    if (page_change == 'custom_change'){
        if (custom_empty){
            if (custom_empty_state_changed){
                addr_obj.disabled = false;
                amt_obj.disabled = false;
                label_obj.disabled = false;
                message_obj.disabled = false;
                uri_checkbox_obj.disabled = false;
                addr_obj.value = stored_addr;
                amt_obj.value = stored_amt;
                label_obj.value = stored_label;
                message_obj.value = stored_message;
            }
        } 
        else {
            if (custom_empty_state_changed){
                addr_obj.disabled = true;
                amt_obj.disabled = true;
                label_obj.disabled = true;
                message_obj.disabled = true;
                uri_checkbox_obj.disabled = true;
                store_values();
            }
            addr_obj.value = "";
            amt_obj.value = "";
            label_obj.value = "";
            message_obj.value = "";
        }
    }
    else if (page_change == 'uri_change'){  //store value
            if (!uri_checked){ //uri was just uchecked 
                store_values();
                amt_obj.value = "";
                label_obj.value = "";
                message_obj.value = "";
            }
            else {  //uri was just checked
                amt_obj.value = stored_amt;
                label_obj.value = stored_label;
                message_obj.value = stored_message; 
            }
    }
	// We're forcing generator to add a uri string when the textboxes are empty and something is entered.
    else if (uri_checked == false && (page_change == 'amt_change' || page_change == 'label_change' || page_change == 'message_change') ) {
        if (amt_empty == false || label_empty == false || message_empty == false) {
        // At this point we know that something is entered into the boxes.
            //check uri checkbox
            uri_checkbox_obj.checked = true;
        }
    }
    //Run this again to update variables to the latest page updates.
    get_current_page_state();
}


//Stores the last valid values.
function store_values(){
    stored_addr = addr_obj.value;
    stored_amt = amt_obj.value;
    stored_label = label_obj.value;
    stored_message = message_obj.value;
}


//Sets 'addr_empty', 'addr_valid', and 'stored_addr'.
function check_address(){
    var addr_valid_html_obj;
    //addr_valid_html_obj = document.getElementById('is_address_valid');
    addr_obj = document.getElementById('address');

    //If address is empty, record it as so. 
    if (addr_obj.value == ""){
        addr_empty = true;
        addr_valid = false;
    }
    //Otherwise, check to see if address is valid.
    else {
        addr_empty = false;
        //This calls the validate function in wallet-address-validator.js file, which returns true or false. 
        addr_valid = WAValidator.validate(addr_obj.value);
        if (addr_valid){ 
            //Display whether address is valid to user.
            //addr_valid_html_obj.innerHTML = "yes";
            //addr_valid_html_obj.style.color = "black";
        }
        else {
            //addr_valid_html_obj.innerHTML = "no";
            //addr_valid_html_obj.style.color = "red";
        }
    }
}
//Sets 'amt_valid', 'amt_empty', 'last_amt', and 'stored_amt'.
function check_amount() {
    //Remove any leading zeroes from amount.
    if( /^0+(\d+(\.\d*)?)/.test(amt_obj.value)) {
        var match_array;
        match_array = /^0+(\d+(\.\d*)?)/.exec(amt_obj.value);
        amt_obj.value = match_array[1]; 
    }
    //Check whether amount is valid.
    //The amount input can have 8 digits and 8 decimal places. 
    //1 Satoshi = 0.00000001 Bitcoin, lowest amount of btc.
    if ( /^\d{1,8}(\.\d{1,8})?$/.test(amt_obj.value) ) {
        amt_valid = true;
        amt_empty = false;
    }
    //Check to see if amount is empty.
    else if ( amt_obj.value == "" ) {
        amt_valid = false;
        amt_empty = true;
    }
    //Check to see if amount has hanging decimal point.
    else if ( /^\d{1,8}\.$/.test(amt_obj.value) ) {
        amt_valid = false;
        amt_empty = false;
    }
    //Otherwise, input is not a valid number.
    else {
        //Replace with last valid amount.
        amt_obj.value = last_amt;
    }
    last_amt = amt_obj.value;
}

//Sets 'label_empty', 'uri_encoded_label', and 'stored_label'.
function check_label() {
    //If label empty, mark it as such. 
    if ( label_obj.value == "" ) {
        label_empty = true;
        uri_encoded_label = "";
    }
    //Otherwise, uri encode label.
    else {
        label_empty = false;
        //Encode URI sensitive characters in label.
        uri_encoded_label = encodeURIComponent(label_obj.value);
    }
}

//Sets 'message_empty', 'uri_encoded_message', and 'stored_message'.
function check_message() {
    //If message empty, mark it as such. 
    if ( message_obj.value == "" ) {
        message_empty = true;
        uri_encoded_message = "";
    }
    //Otherwise, uri encode message.
    else {
        message_empty = false;
        //Encode URI sensitive characters in message.
        uri_encoded_message = encodeURIComponent(message_obj.value);
    }
}

//Sets 'custom_empty' (for a custom QR code not in the bitcoin uri format).
function check_custom_value() {
    //If custom string is empty, mark it so. 
    if ( custom_obj.value == "" ) {
        if (custom_empty == false){
            custom_empty_state_changed = true;
        }
        else{
            custom_empty_state_changed = false;
        }
        custom_empty = true;
    }
    //Otherwise, mark as not empty. 
    else {
        if (custom_empty == true){
            custom_empty_state_changed = true;
        }
        else{
            custom_empty_state_changed = false;
        }
        custom_empty = false;
    }
}


//Record whether URI checkbox is presently checked.
function record_uri_checkbox_state(){
    if (uri_checkbox_obj.checked) {
        uri_checked = true;
    }
    else {
        uri_checked = false;
    }
}

function get_current_page_state(){
        check_address();
        check_amount();
        check_label();
    check_message()
        check_custom_value();
        record_uri_checkbox_state();
}

//Why is this in a function that gets called over and over?
// Maybe because the objects haven't been loaded yet.
// Could use an initialize function?
function define_html_id_variables(){
        uri_checkbox_obj = document.getElementById('uri');
        amt_obj = document.getElementById('amount');
        label_obj = document.getElementById('label');
        message_obj = document.getElementById('message');
        custom_obj = document.getElementById('custom_id');
        addr_obj = document.getElementById('address');
}

//Generates a QR-code if all values check out.
function gen_qrcode(page_change){
        define_html_id_variables();

        //This function sets variables like addr_valid, paving the wave for the clear conditional logic below.
        get_current_page_state();
        
        //Stores values for later retrieval.
//        store_values();

        //Depending on which value was most recently changed, 
    //the page may need to be updated (i.e. certain fields blanked out).
console.log("page_change= " + page_change);
        update_page(page_change);

        var qr_code_value = determine_qr_code_value();
console.log("qr code value: " + qr_code_value);

        //Clear the last QR Code.
        hide_qrcode();
    make_qrcode(qr_code_value);
}


    // Use a default bitcoin address onload to show the user that the page works.
    // Zero everything else out.
    document.getElementById("address").value = "1BvBMSEYstWetqTFn5Au4m4GFg7xJaNVN2";
    document.getElementById("amount").value = "";
    document.getElementById("label").value = "";
    document.getElementById("message").value = "";
    document.getElementById("custom_id").value = "";
    document.getElementById("uri").checked = true;
    
    //See if we can generate a code.
    gen_qrcode();

    // Listen for download click.
    document.getElementById("dwn-btn").addEventListener("click", function(){
        var qr_img_src = document.getElementById("qr_img").src;
        var filename = "Custom_QR_Code.png"; 
        if ( addr_obj.value != "" ) { 
            filename = addr_obj.value + ".png";
        }
        download(filename, qr_img_src);
    }, false);

    //Download file.
    function download(fname, data_uri) {
        //Create temporary a href link html element for downloading image.
        var element = document.createElement('a');
        element.setAttribute('href', data_uri);
        element.setAttribute('download', fname);
        element.style.display = 'none';
        document.body.appendChild(element);
        //Simulate download click.
        element.click();
        //Destroy a href link html element.
        document.body.removeChild(element);
    }

    function address_error (){
        document.getElementById("address").style.border = "2px solid red";
        document.getElementById("address").style.boxShadow = "0 0 1px 4px rgb(255, 0, 0, .4)";
        document.getElementById("validitation_text").style.visibility = "visible";
        document.getElementById("validitation_text").innerHTML = "Invalid Bitcoin address!";
        document.getElementById("validitation_text").style.color = "red";
        address_valid_state = "false";
    }
    function address_valid (){
        document.getElementById("address").style.border = "2px solid #00b300";
        document.getElementById("address").style.boxShadow = "0 0 1px 4px rgb(0, 255, 0, .4)";
        document.getElementById("validitation_text").style.visibility = "visible";
        document.getElementById("validitation_text").innerHTML = "Valid Bitcoin address.";
        document.getElementById("validitation_text").style.color = "green";
        address_valid_state = "true";
    }
    function lose_address_focus(){
        if (address_valid_state != "unset"){
            document.getElementById("address").style.boxShadow = "none";
        }
    }
    function gain_address_focus(){
        if (address_valid_state == "true"){
            address_valid();
        }
        else if (address_valid_state == "false"){
            address_error();
        }
    }




</script>
