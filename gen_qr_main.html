<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<script src="qrcode.js"></script>
<script src="wallet-address-validator.js"></script>
<script type="text/javascript">

//HTML element ID variables.
var uri_checkbox_obj;
var amt_obj;
var label_obj;
var message_obj;
var custom_obj;
var addr_obj;

//Set whenever user modifies an input box, let's gen_qrcode() subroutine know what input was changed.
var page_change;

//Other variables.
var addr_valid = false;  //Records whether bitcoin address is valid or not at a given time.
var addr_empty = true;  //Records whether the address field is empty or not at a given time.
var stored_addr = "";   //Records the current address field, so that it can be brought back at a later time.

var amt_valid = false;
var amt_empty = true;
var last_valid_amt = "";
var stored_amt = "";

var uri_encoded_label = "";
var label_empty = true;
var stored_label = "";

var uri_encoded_message = "";
var message_empty = true;
var stored_message = "";

var custom_empty = true;
var stored_custom = "";

var uri_checked = false;

var bitcoin_uri;

function determine_qr_code_value(){
	var qr_value = "";
	if (custom_empty){
		if (addr_valid){
			if (uri_checked){
				//Do not generate a QR-Code if amount is not empty and not a valid number.
				if (!amt_valid && !amt_empty){
						qr_value = "";
						return qr_value;
				}
				//Otherwise, generate a QR-Code value in uri format.
				else{
					qr_value = "bitcoin:" + addr_obj.value;
				}
				//Create array of fields and one with their values to add to uri.
				var uri_field_name_array = [];
				var uri_field_value_array = [];
				if (amt_valid){
					uri_field_name_array.push("amount");
					uri_field_value_array.push(amt_obj.value);
				}
				if (!label_empty){
console.log("label");
					uri_field_name_array.push("label");
					uri_field_value_array.push(uri_encoded_label);
				}
				if (!message_empty){
console.log("message");
					uri_field_name_array.push("message");
					uri_field_value_array.push(uri_encoded_message);
				}
				//If fields are present, prepare uri with '?', otherwise, return current uri.
				if (uri_field_value_array.length > 0){
					qr_value = qr_value + "?";
				}
				else{
					return qr_value;
				}
				//Populate uri with field names and values.
				while (uri_field_name_array.length > 0){
console.log(uri_field_name_array.length);
					qr_value = qr_value + uri_field_name_array.shift() + "=" + uri_field_value_array.shift();
					if (uri_field_name_array.length > 0){
						qr_value = qr_value + "&";
					}
				}
				return qr_value;
			}
			//If uri checkbox not checked, then the QR-code is just the address.
			else{
				qr_value = addr_obj.value;
				return qr_value;
			}
		}
		//If address is invalid, no valid qr code value.
		else{
			qr_value = "";
			return qr_value;
		}
	}
	//If custom value is filled, then QR-Code value defaults to that.
	else{
		qr_value = custom_obj.value;
		return qr_value;
	}
}

function hide_qrcode(){
	document.getElementById('your_address_id').innerHTML = "";
	document.getElementById('qrcode_id').innerHTML = "";
	//Don't show a QR Code unless it is a valid one.
    	document.getElementById("dwn-btn").style.visibility = "hidden";
}

function make_qrcode(input_text){
	var qrcode;
	//Input fully formed address/uri in readable html.
	document.getElementById('your_address_id').innerHTML = input_text;
	qrcode = new QRCode("qrcode_id");
	qrcode.makeCode(input_text);
	document.getElementById("dwn-btn").style.visibility = "visible";
}

//Update page based on change of page_change variable (which records the most recent change to the page by the user).
//The "page_change" variable is whichever field was modified (addr_change, amt_change, label_change, message_change, custom_change, or uri_change.)
function update_page(){
        if (page_change == 'addr_change' || page_change == 'amt_change' || page_change == 'label_change' || page_change == 'message_change'){
                if (addr_empty && amt_empty && label_empty && message_empty){
                        custom_obj.value == stored_custom;
                }
                else{
                        custom_obj.value == "";
                }
        }
        else if (page_change == 'custom_change'){
                if (custom_empty){
                        addr_obj.value = stored_addr;
                        amt_obj.value = stored_amt;
                        label_obj.value = stored_label;
                        message_obj.value = stored_message;
                }
                else{
                        addr_obj.value = "";
                        amt_obj.value = "";
                        label_obj.value = "";
                        message_obj.value = "";
                }
        }
        else if (page_change == 'uri_change'){
                custom_obj.value == "";
                if (!uri_checked){
                        amt_obj.value = "";
                        label_obj.value = "";
                        message_obj.value = "";
                }
        }
        //Run this again to update variables to the latest page updates.
        get_current_page_state();
}


//Stores the last valid values.
function store_values(){
        if (addr_valid){
                stored_addr = addr_obj.value;
        }
        if (amt_valid){
                stored_amt = amt_obj.value;
        }
        if(!label_empty){
                stored_label = label_obj.value;
        }
        if (!message_empty){
		stored_message = message_obj.value;
        }
        if (!custom_empty){
                stored_custom = custom_obj.value;
        }
}


//Sets 'addr_empty', 'addr_valid', and 'stored_addr'.
function check_address(){
	var addr_valid_html_obj;
	addr_valid_html_obj = document.getElementById('is_address_valid');
	addr_obj = document.getElementById('address');

	//If address is empty, record it as so. 
	if (addr_obj.value == ""){
		addr_empty = true;
		addr_valid = false;
	}
	//Otherwise, check to see if address is valid.
	else {
		addr_empty = false;
		//This calls the validate function in wallet-address-validator.js file, which returns true or false. 
		addr_valid = WAValidator.validate(addr_obj.value);
		if (addr_valid){ 
			//Display whether address is valid to user.
			addr_valid_html_obj.innerHTML = "yes";
			addr_valid_html_obj.style.color = "black";
		}
		else {
			addr_valid_html_obj.innerHTML = "no";
			addr_valid_html_obj.style.color = "red";
		}
	}
}

//Sets 'amt_valid', 'amt_empty', 'last_valid_amt', and 'stored_amt'.
function check_amount() {
	var amt_valid_html_obj;
	amt_valid_html_obj = document.getElementById('is_amount_valid');

	//Remove any leading zeroes from amount.
	if( /^0+(\d+(\.\d*)?)/.test(amt_obj.value)) {
		var match_array;
		match_array = /^0+(\d+(\.\d*)?)/.exec(amt_obj.value);
		amt_obj.value = match_array[1]; 
	}
	//Check whether amount is valid.
	//The amount input can have 8 digits and 8 decimal places. 
	//1 Satoshi = 0.00000001 Bitcoin, lowest amount of btc.
	if ( /^\d{1,8}(\.\d{1,8})?$/.test(amt_obj.value) ) {
		amt_valid = true;
		amt_empty = false;
		last_valid_amt = amt_obj.value;     //Store the last known good input value.
		amt_valid_html_obj.innerHTML = "valid";  
		amt_valid_html_obj.style.color = "green";
	}
	//Check to see if amount is empty.
	else if ( amt_obj.value == "" ) {
		amt_valid = false;
		amt_empty = true;
		last_valid_amt = amt_obj.value;
		amt_valid_html_obj.innerHTML = "empty";
		amt_valid_html_obj.style.color = "yellow";
	}
	//Check to see if amount has hanging decimal point.
	else if ( /^\d{1,8}\.$/.test(amt_obj.value) ) {
		amt_valid = false;
		amt_empty = false;
		amt_valid_html_obj.innerHTML = "decimal";
		amt_valid_html_obj.style.color = "blue";
	}
	//Otherwise, input is not a valid number.
	else {
		//Replace with last valid amount.
		amt_obj.value = last_valid_amt;
	}
}

//Sets 'label_empty', 'uri_encoded_label', and 'stored_label'.
function check_label() {
	//If label empty, mark it as such. 
	if ( label_obj.value == "" ) {
		label_empty = true;
		uri_encoded_label = "";
	}
	//Otherwise, uri encode label.
	else {
		label_empty = false;
		//Encode URI sensitive characters in label.
		uri_encoded_label = encodeURIComponent(label_obj.value);
	}
}

//Sets 'message_empty', 'uri_encoded_message', and 'stored_message'.
function check_message() {
	//If message empty, mark it as such. 
	if ( message_obj.value == "" ) {
		message_empty = true;
		uri_encoded_message = "";
	}
	//Otherwise, uri encode message.
	else {
		message_empty = false;
		//Encode URI sensitive characters in message.
		uri_encoded_message = encodeURIComponent(message_obj.value);
	}
}

//Sets 'custom_empty' and 'stored_custom' (for a custom QR code not in the bitcoin uri format).
function check_custom_value() {
	//If custom string is empty, mark it so. 
	if ( custom_obj.value == "" ) {
		custom_empty = true;
	}
	//Otherwise, mark as not empty. 
	else {
		custom_empty = false;
	}
}

//Record whether URI checkbox is presently checked.
function check_uri_checkbox(){
	if (uri_checkbox_obj.checked) {
		uri_checked = true;
	}
	else {
		uri_checked = false;
	}
}

function get_current_page_state(){
        check_address();
        check_amount();
        check_label();
        check_custom_value();
        check_uri_checkbox();
}

//Why is this in a function that gets called over and over?
// Maybe because the objects haven't been loaded yet.
// Could use an initialize function?
function define_html_id_variables(){
        uri_checkbox_obj = document.getElementById('uri');
        amt_obj = document.getElementById('amount');
        label_obj = document.getElementById('label');
        message_obj = document.getElementById('message');
        custom_obj = document.getElementById('custom_id');
        addr_obj = document.getElementById('address');
}

//Generates a QR-code if all values check out.
function gen_qrcode(page_change){
//alert("\nEntered gen_qrcode");
        define_html_id_variables();

        //This function sets variables like addr_valid, paving the wave for the clear conditional logic below.
        get_current_page_state();
        
        //Stores values for later retrieval.
        store_values();

        //Depending on which value was most recently changed, 
	//the page may need to be updated (i.e. certain fields blanked out).
        update_page();

        var qr_code_value = determine_qr_code_value();
console.log(qr_code_value);

        //Clear the last QR Code.
        hide_qrcode();
                make_qrcode(custom_obj.value);
}


</script>


<div> Enter Bitcoin Address:
    <input oninput="gen_qrcode('addr_change')" type="text" id="address" style="width:280; height:50; font-size:22px"><p id="is_address_valid" style="color:red"></p>
</div>
<div> Enter Amount to send:
    <input oninput="gen_qrcode('amt_change')" type="text" id="amount" style="width:280; height:50; font-size:22px"><p id="is_amount_valid" style="color:red"></p>
</div>
<div> Enter Label:
    <input oninput="gen_qrcode('label_change')" type="text" id="label" style="width:280; height:50; font-size:22px">
</div>
<div> Enter Message:
    <input oninput="gen_qrcode('message_change')" type="text" id="message" style="width:280; height:50; font-size:22px">
</div>
<div> Custom String:
    <input oninput="gen_qrcode('custom_change')" type="text" id="custom_id" style="width:280; height:50; font-size:22px">
</div>
<div>Check to make QR Code in Bitcoin URI format: <input oninput="gen_qrcode('uri_change')" type="checkbox" id="uri">
</div>
QR Code Value:
<p id="qr_val" style="color:green"></p>
<br>
<p id=your_address_id></p>
<br>
<div id="qrcode_id"></div>
<br>
<input type="button" id="dwn-btn" style="visibility:hidden" value="Download QR Code"/>


<script>
	//See if we can generate a code.
	gen_qrcode();

	// Listen for download click.
	document.getElementById("dwn-btn").addEventListener("click", function(){
		var qr_img_src = document.getElementById("qr_img").src;
		var filename = addr_obj.value + ".png";
		download(filename, qr_img_src);
	}, false);

	//Download file.
	function download(fname, data_uri) {
		//Create temporary a href link html element for downloading image.
		var element = document.createElement('a');
		element.setAttribute('href', data_uri);
		element.setAttribute('download', fname);
		element.style.display = 'none';
		document.body.appendChild(element);
		//Simulate download click.
		element.click();
		//Destroy a href link html element.
		document.body.removeChild(element);
	}
</script>

</html>
